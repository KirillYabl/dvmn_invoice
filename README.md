# Скрипт скачивания формирования счетов

1. Скачивает данные по ревью для всех ревьюеров (доступно только юзерам с определенной ролью на девмане)
2. Для каждого создает файл на гугл диске
3. Каждому присылает уведомление в телеграм

## Содержимое

1. [Как установить](#setup)
2. [Как запустить](#run)
3. [Пример заполненного файла с переменными окружения](#env)

<a name="setup"></a>
## Как установить

1. Создать credentials для гугла

    Вот норм [статья](https://habr.com/ru/sandbox/191038/) с пошаговой инструкцией, если в доке слишком запутано.
    Где говорится переходим в пайтон, там вместо программы используем не то, что он предлагает, а именно этот скрипт.
    После того, как подцепимся к гуглу он создаст файл с авторизованными данными юзера и в дальнейшем, те шаги, которые там описаны
    после упоминания питона повторять не нужно будет.

2. Создать API_ID и API_HASH для телеграма по [этому гайду](https://docs.telethon.dev/en/stable/basic/signing-in.html#signing-in)

3. Заполнить переменные окружения в файле `.env`, рядом со скриптом
    - `GOOGLE_CREDENTIALS_FILE_PATH` - путь к файлу с credentials гугла
    - `GOOGLE_AUTHORIZED_USER_FILE_PATH` - путь к файлу с авторизованной сессией после первичной регистрации, по этому пути скрипт сохранит файл и будет использовать в дальнейшем
    - `DEVMAN_TOKEN` - токен девмана, взять его можно по адресу https://dvmn.org/api/docs/
    - `MONTH` - номер месяца, за который делать отчет, если не заполнять, то будет взят предыдущий
    - `YEAR` - год, за который делать отчет, если не заполнять, то будет взят год предыдущего месяца
    - `GOOGLE_TABLE_NAME` - шаблон имени таблицы на гугл диске, доступны две переменные: {year_month} - конкатенация через _ года и месяцп отчета, например 2023_07 и {username} - username ревьюера на девмане
    - `TELEGRAM_API_ID` - API ID телеграма
    - `TELEGRAM_API_HASH` - API HASH телеграма
    - `CONFIRM_EVERY_REVIEWER` - если True, то по каждому ревьюеру, прежде чем делать отчет и отправлять, будет спрашивать, делать по нему или пропускать, если например нужно передалать по какому-то человеку, но не спамить всех
    - `MESSAGE_TEMPLATE_FILENAME` - имя файл с шаблоном текста сообщения, доступны переменные {year} - год отчета, {month} - месяц отчета и  {spreadsheet_url} - ссылка на созданную таблицу

4. Создать виртуальное окружение и установить зависимости

    ```
    python -m venv venv
    pip install -r requirements.txt
    ```

    Зависимости указаны для python 3.10.4, для более старых версий возможно придется что-то поправить.

<a name="run"></a>
## Как запустить

Просто запутить скрипт `run.py`

```
python run.py
```

При первом запуске скрипт (библиотека telethon) попросит зарегистрировать устройство в телеграме, попросив ввести:
- логин
- код аутиентификации, который он отправит в телеграм
- пароль, если подключена двухфакторная аутентификация

<a name="env"></a>
## Пример заполненного файла с переменными окружения

```
GOOGLE_CREDENTIALS_FILE_PATH=credentials.json
GOOGLE_AUTHORIZED_USER_FILE_PATH=authorized_user.json
DEVMAN_TOKEN=YOUR_TOKEN
GOOGLE_TABLE_NAME={year_month}_{username}_month_reviews
TELEGRAM_API_ID=YOUR_API_ID
TELEGRAM_API_HASH=YOUR_API_HASH
CONFIRM_EVERY_REVIEWER=False
MESSAGE_TEMPLATE_FILENAME=message.txt
```
